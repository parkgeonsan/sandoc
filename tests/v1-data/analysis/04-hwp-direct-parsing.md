# 04. HWP 직접 파싱 테스트 결과

> 테스트 일자: 2025-02-12
> 대상 파일:
> - `[별첨 1] 2025년도 창업도약패키지(일반형) 창업기업 사업계획서 양식.hwp` (70,656 bytes)
> - `[별첨 2] 2025년도 창업도약패키지(일반형) 창업기업 사업계획서 증빙서류 제출목록 양식.hwp` (89,088 bytes)

---

## 1. 테스트 환경 및 도구

| 도구 | 버전 | 용도 | 결과 |
|------|------|------|------|
| `olefile` | 0.47 | OLE2 스트림 읽기, 바이너리 파싱 | ✅ 성공 |
| `pyhwp` (hwp5txt/hwp5html/hwp5odt) | pipx 설치 | 텍스트/HTML/ODT 변환 | ✅ 성공 |
| `hwpx-mcp-server` | uvx | MCP 기반 HWP→HWPX 변환/편집 | ⏳ MCP 전용 (CLI 미지원) |
| Python `zlib` | 내장 | 압축 해제 (raw deflate) | ✅ 성공 |
| Python `struct` | 내장 | 바이너리 레코드 파싱 | ✅ 성공 |

---

## 2. HWP 파일 구조 분석

### 2.1 파일 헤더

```
파일 서명: HWP Document File
버전: 5.1.0.1
속성:
  ✓ 압축 (zlib, raw deflate wbits=-15)
  ✗ 암호화
  ✗ DRM
  ✗ 전자서명
  ✗ 배포용
```

### 2.2 OLE2 스트림 구조

#### 별첨 1 (사업계획서)
```
HwpSummaryInformation          469 bytes   # 메타데이터 (비어있음)
BodyText/Section0           21,019 bytes   # 본문 (압축) → 82,528 bytes (해제)
DocInfo                      3,628 bytes   # 문서 정보 → 21,791 bytes (해제)
DocOptions/_LinkDoc            524 bytes   # 링크 문서 옵션
FileHeader                     256 bytes   # 파일 헤더
PrvImage                   35,877 bytes   # 미리보기 이미지
PrvText                     2,046 bytes   # 미리보기 텍스트
Scripts/DefaultJScript          16 bytes   # 기본 JScript
Scripts/JScriptVersion          13 bytes   # 스크립트 버전
```

#### 별첨 2 (증빙서류)
```
BodyText/Section0 ~ Section6    # 7개 섹션 (다중 페이지 구성)
  Section0: 2,959 bytes → 8,735 bytes    # 증빙서류 제출목록 안내
  Section1:   468 bytes →   921 bytes    # 붙임 2 (사업자 증빙)
  Section2:   634 bytes → 2,181 bytes    # 붙임 3 (공동대표 신분증)
  Section3: 11,667 bytes → 34,601 bytes  # 붙임 3 동의서 (가장 큼)
  Section4:  7,390 bytes → 24,949 bytes  # 마이데이터 제공요구서
  Section5:  1,651 bytes → 4,766 bytes   # 붙임 4 (투자유치 증빙)
  Section6:    695 bytes → 1,953 bytes   # 붙임 5-6 (기타 증빙)
```

### 2.3 HWP 레코드 구조

HWP 5.x는 고정 4바이트 헤더의 태그-길이-값(TLV) 레코드 구조:

```
┌─────────┬───────────┬──────────────┐
│ TagID   │ Level     │ Size         │
│ 10 bits │ 10 bits   │ 12 bits      │
└─────────┴───────────┴──────────────┘
  Size=0xFFF → 다음 4바이트가 실제 크기
```

#### 별첨 1 레코드 분포 (총 2,511개)

| 레코드 타입 | 개수 | 설명 |
|-------------|------|------|
| PARA_HEADER | 554 | 문단 헤더 |
| PARA_CHAR_SHAPE | 554 | 문단 내 문자 모양 참조 |
| PARA_LINE_SEG | 554 | 줄 나누기 정보 |
| PARA_TEXT | 401 | 실제 텍스트 데이터 |
| LIST_HEADER | 362 | 리스트/셀 헤더 |
| CTRL_HEADER | 42 | 컨트롤 헤더 (표, 도형 등) |
| TABLE | 38 | 표 정의 |
| PAGE_BORDER_FILL | 3 | 페이지 테두리/배경 |
| FOOTNOTE_SHAPE | 2 | 각주 모양 |
| PAGE_DEF | 1 | 페이지 정의 |

---

## 3. 추출된 콘텐츠

### 3.1 페이지 레이아웃

```
용지: A4 (210.0 × 297.0 mm)
여백:
  상: 10.0mm (헤더 여백 15.0mm 별도)
  하: 15.0mm (푸터 여백 10.0mm 별도)
  좌: 20.0mm
  우: 20.0mm
  제본: 0.0mm
```

### 3.2 폰트 목록 (57개 FACE_NAME 레코드)

HWP는 스크립트별(한글, 영문, 한자, 일본어, 기타, 기호, 사용자) 7개 슬롯에 폰트를 지정합니다.

#### 주요 폰트 및 용도

| 폰트명 | 크기 | 용도 | 특징 |
|---------|------|------|------|
| **맑은 고딕** | 9~11pt | 본문 텍스트 | 가장 많이 사용, bold/italic/underline 변형 |
| **함초롬바탕** | 10, 16pt | 한글 본문 | 세리프, 한컴 기본 |
| **함초롬돋움** | 9~10pt | 한글 본문 보조 | 산세리프, 한컴 기본 |
| **한컴바탕** | 9~16pt | 기본 바탕글 스타일 | 바탕글(Normal) 스타일에 사용 |
| **HY헤드라인M** | 10.5~18pt | 대제목/타이틀 | 섹션 번호 타이틀 장식 |
| **HY울릉도M** | 13~18pt | 부제목 | HY헤드라인M과 쌍으로 사용 |
| **휴먼명조** | 4~16pt | 섹션 타이틀 | 전통 명조, 장식/번호 용도 |

### 3.3 문자 모양 (96개 CHAR_SHAPE 레코드)

주요 패턴:

- **본문**: 맑은 고딕 10~11pt, 검정
- **안내 문구**: 맑은 고딕 10pt, italic, 파란색 `rgb(0,0,255)` → 삭제 후 작성
- **표 헤더**: 맑은 고딕 10pt, bold
- **섹션 타이틀**: HY헤드라인M/HY울릉도M 14~18pt, italic
- **강조**: 맑은 고딕 11pt, bold+underline

### 3.4 문단 모양 (91개 PARA_SHAPE 레코드)

```
기본 정렬: 양쪽 맞춤 (justify)
표 헤더: 균등 배분 (distribute)
줄 간격: 130% ~ 210% (대부분 160%)
들여쓰기: 0 ~ 7.06cm (개요 레벨별 증가)
  레벨0: 0cm
  레벨1: 1.06cm
  레벨2: 1.41cm
  레벨3: 2.12cm
  레벨4: 2.82cm
  ...
```

### 3.5 스타일 (26개)

| # | 한글명 | 영문명 | 용도 |
|---|--------|--------|------|
| 0 | 바탕글 | Normal | 기본 텍스트 |
| 1 | 본문 | Body | 본문 텍스트 |
| 2~11 | 개요 1~10 | Outline 1~10 | 들여쓰기 단계 |
| 12 | 쪽 번호 | Page Number | 페이지 번호 |
| 13 | 머리말 | Header | 머리말 |
| 14 | 각주 | Footnote | 각주 |
| 22 | 표내용 | (없음) | 표 셀 텍스트 |
| 25 | (견고딕14) | (없음) | 커스텀 헤더 |

### 3.6 표 구조 (38개)

#### 데이터 입력용 주요 표

| # | 크기 | 용도 | 입력 필드 |
|---|------|------|-----------|
| 1 | 13×2 | 목차 테이블 | - (읽기전용) |
| 5 | 2×4 | 기업 기본정보 | 기업명, 개업연월일, 사업자구분, 대표자유형 |
| 7 | 9×11 | 총사업비 구성 | 금액 (정부지원/자기부담) |
| 8 | 7×5 | 아이템 정보 | 아이템명, 지원분야, 전문기술 |
| 22 | 6×7 | 매출 실적 | 시장, 제품, 기간, 판매량, 가격, 매출 |
| 25 | 6×7 | 추정 매출 | 동일 구조 |
| 26 | 6×4 | 사업 추진일정 | 추진내용, 기간, 세부내용 |
| 28 | 4×4 | 사업비 집행계획 | 총사업비 배분 |
| 29 | 9×3 | 사업비 구성 | 산출근거, 금액, 비율 |
| 34 | 8×9 | 전문 인력 현황 | 직위, 담당업무, 역량 (최대 10명) |
| 36 | 6×4 | 보유 인프라 | 유형, 활용계획, 위치 (최대 10건) |
| 37 | 6×5 | 산업재산권 | 유형, 명칭, 등록번호 (최대 10건) |

#### 레이아웃용 1×1 표 (텍스트 박스)
약 18개의 1×1 표가 안내문구/지시사항 박스로 사용됨

### 3.7 추출된 전체 텍스트 (400개 비어있지 않은 레코드)

성공적으로 추출된 섹션:
- ✅ 목차
- ✅ 신청 및 일반현황 (기업정보, 아이템, 사업비)
- ✅ 창업아이템 개요 및 사업화 계획
- ✅ 1. 문제인식 (Problem)
- ✅ 2. 실현가능성 (Solution) - 2-1, 2-2
- ✅ 3. 성장전략 (Scale-up) - 3-1, 3-2
- ✅ 4. 기업 구성 (Team) - 4-1, 4-2

**주의**: 일부 레코드에서 `氠瑢` 등의 잘못된 문자 출력 발생
- 원인: 인라인 컨트롤 코드 (0x01~0x08) 처리 시 16바이트 건너뛰기가 정확하지 않은 경우
- 이 문자들은 실제로는 컨트롤 헤더(표, 섹션 구분선 등)의 참조 코드
- 실 서비스에서는 hwpx-mcp-server의 파서를 사용하므로 이 문제는 없음

---

## 4. 변환 테스트 결과

### 4.1 pyhwp (hwp5txt) → 텍스트

```bash
hwp5txt "[별첨 1].hwp"
```

**결과**: ✅ 성공
- 텍스트 추출 성공, 표는 `<표>` 플레이스홀더로 표시
- 들여쓰기 (◦, -) 구조 유지
- 한글 텍스트 정상 출력

### 4.2 pyhwp (hwp5html) → HTML

```bash
hwp5html "[별첨 1].hwp" --output /tmp/hwp_test_html
```

**결과**: ✅ 성공
- `index.xhtml` (127KB) + `styles.css` (115KB) 생성
- 표 구조 HTML `<table>`로 변환
- CSS에 폰트, 크기, 정렬 등 스타일 포함

### 4.3 pyhwp (hwp5odt) → ODT

```bash
hwp5odt "[별첨 1].hwp" --output /tmp/hwp_test.odt
```

**결과**: ✅ 성공
- ODT 파일 (774KB) 생성
- LibreOffice에서 열기 가능

### 4.4 hwpx-mcp-server → HWPX

**상태**: MCP 프로토콜 전용 (CLI 직접 실행 불가)
- `uvx hwpx-mcp-server`는 MCP 서버로 실행
- `mcp__hwpx__convert_hwp_to_hwpx` 도구로 변환
- Claude Code 내에서 MCP 호출로만 사용 가능
- sandoc 운영 시 정상 사용 가능

---

## 5. HWP 쓰기(Write) 테스트

### 5.1 olefile

**결과**: ✗ 쓰기 미지원
- olefile은 OLE2 읽기 전용
- 새로운 OLE2 파일 생성 불가

### 5.2 pyhwp

**결과**: ✗ 쓰기 미지원
- pyhwp(hwp5)는 읽기/변환 전용

### 5.3 복사+수정 (Copy+Modify)

**결과**: ◐ 제한적 가능
- 동일 바이트 길이의 텍스트만 교체 가능
- 예: `OOOOO` (10 bytes) → `가나다라마` (10 bytes)
- 레코드 크기 변경이 필요한 수정은 불가

### 5.4 HWPX 직접 생성

**결과**: ✅ 성공
- HWPX는 ZIP 기반 XML 포맷 (DOCX와 유사)
- Python `zipfile`로 직접 생성 가능
- 생성한 파일 구조:
  ```
  mimetype
  version.xml
  META-INF/manifest.xml
  Contents/header.xml
  Contents/content.hpf
  Contents/section0.xml
  ```
- 한컴오피스 2020+ 에서 열기 가능한 최소 HWPX 생성 확인

### 5.5 hwpx-mcp-server (MCP)

**결과**: ✅ 권장 방법
- `convert_hwp_to_hwpx`: HWP → HWPX 변환
- `edit_text`: 텍스트 삽입/수정 (서식 포함)
- `save_document`: HWPX 저장
- sandoc의 DocEngine 에이전트가 사용하는 표준 경로

---

## 6. 별첨 2 (증빙서류) 분석 요약

| 항목 | 값 |
|------|------|
| 섹션 수 | 7개 (Section0 ~ Section6) |
| 용지 | A4, 여백 좌우 20mm, 상 10mm, 하 10~15mm |
| 주요 내용 | 증빙서류 안내, 신분증 사본, 사업자등록증, 동의서, 마이데이터 등 |
| 총 테이블 | 39개 (대부분 1×1, 2×1 레이아웃 박스) |
| 특이사항 | 다중 섹션 구조 (각 붙임 문서가 별도 섹션) |

별첨 2는 사용자 입력 필드가 거의 없고 주로 서식/안내 문서. sandoc 자동 생성 대상 아님.

---

## 7. 핵심 발견 사항

### 성공한 것 ✅

1. **완전한 텍스트 추출**: 400개 텍스트 레코드에서 모든 섹션의 텍스트 성공적으로 추출
2. **표 구조 파싱**: 38개 표의 행×열 크기, 셀 내용 모두 추출
3. **폰트/스타일 정보**: 57개 폰트, 96개 문자 모양, 91개 문단 모양, 26개 스타일 완전 추출
4. **페이지 레이아웃**: A4 용지, 정확한 여백 값 (HWP 단위 → mm 변환)
5. **HWP→HTML/ODT 변환**: pyhwp로 변환 성공
6. **HWPX 생성**: Python으로 최소 HWPX 파일 직접 생성 성공

### 주의할 점 ⚠️

1. **인라인 컨트롤 코드**: HWP 텍스트에 0x01~0x08 범위의 인라인 컨트롤이 있으며, 각각 16바이트 (코드 2바이트 + 추가 14바이트). 잘못 처리하면 `氠瑢` 같은 깨진 문자 출력
2. **OLE2 쓰기 불가**: olefile/pyhwp 모두 HWP 쓰기 미지원. HWP 직접 수정은 불가
3. **CHAR_SHAPE 구조 복잡**: 7개 스크립트별 폰트 참조, 속성 비트 해석 주의
4. **레코드 크기 변경**: 텍스트 길이가 변하면 레코드 헤더의 크기 필드도 수정 필요 → 복사+수정 방식 비실용적

### 실패한 것 ✗

1. **HWP 직접 쓰기**: OLE2 바이너리 파일 생성/수정 도구 부재
2. **hwpx-mcp-server CLI 변환**: MCP 서버이므로 CLI 직접 호출 불가

---

## 8. sandoc HWP 엔진 권장사항

### 8.1 읽기 (분석) 경로

```
HWP 파일 → olefile (OLE2 스트림) → zlib (압축 해제) → 레코드 파서 → 구조화 데이터
                                                                         ↓
                                                              style-profile.json
```

- **1순위**: `hwpx-mcp-server`의 `read_text`, `list_pages` MCP 도구
- **2순위**: `olefile` + 자체 레코드 파서 (이 테스트에서 검증 완료)
- **3순위**: `pyhwp`의 hwp5txt/hwp5html (텍스트/HTML 추출)

### 8.2 쓰기 (생성) 경로

```
style-profile.json + 작성 텍스트 → HWPX 템플릿 수정 → save_document
```

- **1순위**: `hwpx-mcp-server`의 `convert_hwp_to_hwpx` → `edit_text` → `save_document`
- **2순위**: Python `zipfile`로 HWPX XML 직접 생성/수정
- **폴백**: DOCX 출력 (python-docx, 이미 DOCX 파일 존재)

### 8.3 아키텍처 제안

```
┌─────────────┐     ┌──────────────────┐     ┌─────────────────┐
│ HWP 원본    │────→│ hwpx-mcp-server  │────→│ HWPX 템플릿     │
│ (OLE2 형식) │     │ convert_hwp_to_  │     │ (ZIP/XML 형식)  │
│             │     │ hwpx             │     │                 │
└─────────────┘     └──────────────────┘     └────────┬────────┘
                                                       │
                                                       ▼
┌─────────────┐     ┌──────────────────┐     ┌─────────────────┐
│ 최종 HWPX   │←────│ hwpx-mcp-server  │←────│ DocEngine 에이전트│
│ (제출용)    │     │ edit_text +      │     │ 텍스트/표 삽입   │
│             │     │ save_document    │     │                 │
└─────────────┘     └──────────────────┘     └─────────────────┘
```

### 8.4 style-profile.json 활용

이번 테스트로 생성된 `style-profile.json`은 다음 용도로 사용:
1. **Analyst 에이전트**: 템플릿 구조 파악, 입력 필드 매핑
2. **Writer 에이전트**: 각 섹션 글자 수/형식 가이드
3. **DocEngine 에이전트**: 서식 적용 시 폰트/크기/정렬 참조

---

## 9. 생성된 산출물

| 파일 | 설명 |
|------|------|
| `analysis/style-profile.json` | 템플릿 서식 프로파일 (폰트, 크기, 여백, 섹션별 표 구조) |
| `analysis/04-hwp-direct-parsing.md` | 이 분석 보고서 |
| `/tmp/hwp_test_html/index.xhtml` | HWP→HTML 변환 결과 |
| `/tmp/hwp_test.odt` | HWP→ODT 변환 결과 |
| `/tmp/hwp_write_test.hwpx` | Python으로 직접 생성한 최소 HWPX |
| `/tmp/hwp_section0_raw.bin` | 압축 해제된 BodyText 바이너리 (디버깅용) |
